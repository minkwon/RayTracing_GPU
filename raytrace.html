<!DOCTYPE html>
<html lang="en">
<head>
    <script src="js/gpu.min.js"></script>
    <script src="js/three.js"></script>
    <script src="js/helper.js"></script>
    <script src="js/scene.js"></script>
    <meta charset="UTF-8">
    <title>Ray tracing with javascript using GPU.js</title>
</head>
<body>

<input type="button" value="Using CPU" onclick="return changeMode(this);" />
<div id = "fps"></div>
<script>
    // 0: CPU mode, 1: GPU mode
    var selection = 0;
    var WIDTH = 500;
    var HEIGHT = 500;
    var start = null;
    function changeMode(el) {
        if (el.value == "Using CPU") {
            selection = 1;
            el.value = "Using GPU";
        } else {
            selection = 0;
            el.value = "Using CPU";
        }
    }
    var gpu = new GPU();

    // maybe calculate which block to actually calculate first with low resolution, like yes or no
    //        var myFunc = gpu.createKernel(function() {
    //            return this.thread.x;
    //        }, opt);


    // function that calculates vectors for camera
    function getCameraVectors(Camera) {
        var viewPoint = new THREE.Vector3(Camera[0], Camera[1], Camera[2]),
        direction = new THREE.Vector3(Camera[3], Camera[4], Camera[5]),
        fov = Camera[6],
        eyeUnitVect = new THREE.Vector3().subVectors(direction, viewPoint).normalize(),
        rightVect = new THREE.Vector3().crossVectors(eyeUnitVect, new THREE.Vector3(0, 1, 0)),
        upVect = new THREE.Vector3().crossVectors(rightVect, eyeUnitVect),
        fovRadians = Math.PI * (fov / 2) / 180,
        heightWidthRatio = HEIGHT / WIDTH,
        halfWidth = Math.tan(fovRadians),
        halfHeight = heightWidthRatio * halfWidth,
        cameraWidth = halfWidth * 2,
        cameraHeight = halfHeight * 2,
        pixelWidth = cameraWidth / (WIDTH - 1),
        pixelHeight = cameraHeight / (HEIGHT - 1);
        var cameraUnitVectors = [
                eyeUnitVect.getComponent(0),
                eyeUnitVect.getComponent(1),
                eyeUnitVect.getComponent(2),
                rightVect.getComponent(0),
                rightVect.getComponent(1),
                rightVect.getComponent(2),
                upVect.getComponent(0),
                upVect.getComponent(1),
                upVect.getComponent(2),
                cameraWidth,// 9
                cameraHeight,// 10
                pixelWidth, // 11
                pixelHeight // 12
        ];
        return cameraUnitVectors;
    }
    var cV = getCameraVectors(camera);



    // Kernel for rendering output, each thread colors one pixel on the screen
    function render(mode) {
        var opt = {
            dimensions: [WIDTH, HEIGHT],
            debug: false,
            graphical: true,
            safeTextureReadHack: false,
            constants: { OBJCOUNT: objects[0],
                EMPTY: ObjTyp.EMPTY,    SPHERE: ObjTyp.SPHERE,   CUBOID: ObjTyp.CUBOID,
                CYLINDER: ObjTyp.CYLINDER,   CONE: ObjTyp.CONE,   TRIANGLE: ObjTyp.TRIANGLE },
            mode: mode
        };
        var kernalCreatorExpression = gpu.createKernel(function(Camera, Lights, Objects, camVect) {
//            this.color(0.95, 0.95, 0.95); // Grey background color
            // scaling
            var right_x = camVect[3] * (this.thread.x * camVect[11] - camVect[9] * 0.5);
            var right_y = camVect[4] * (this.thread.x * camVect[11] - camVect[9] * 0.5);
            var right_z = camVect[5] * (this.thread.x * camVect[11] - camVect[9] * 0.5);

            var up_x = camVect[6] * (this.thread.y * camVect[12] - camVect[10] * 0.5);
            var up_y = camVect[7] * (this.thread.y * camVect[12] - camVect[10] * 0.5);
            var up_z = camVect[8] * (this.thread.y * camVect[12] - camVect[10] * 0.5);

            var ray_x = Math.sqrt(1);
            var ray_y = Math.sqrt(2);
            var ray_z = Math.sqrt(3);
            this.color(up_x, up_y, up_z);
        }, opt);
        return kernalCreatorExpression;
    }
    // setting up
    var gpuRender = render("gpu");
    var cpuRender = render("cpu");
    var f = document.querySelector("#fps");
    // initial canvas first drawn with GPU
    var result = gpuRender(0, 0, 0, cV);
    var canvas = gpuRender.getCanvas();
    document.getElementsByTagName('body')[0].appendChild(canvas);

    // render loop
    function renderLoop(timestamp) {
        f.innerHTML = fps.getFPS();
        if (selection == 1) {
            gpuRender(0, 0, 0, cV);
            var canv = document.getElementsByTagName("canvas")[0];
            var bdy = canv.parentNode;
            var newCanvas = gpuRender.getCanvas("gpu");
            bdy.replaceChild(newCanvas, canv);
        } else {
            cpuRender(0, 0, 0, cV);
            var canv = document.getElementsByTagName("canvas")[0];
            var bdy = canv.parentNode;
            var newCanvas = cpuRender.getCanvas("cpu");
            bdy.replaceChild(newCanvas, canv);
        }
        // animation goes here
        requestAnimationFrame(renderLoop);
    }
    window.onload = renderLoop;

</script>

</body>
</html>